class MembersController < ApplicationController
  # GET /members
  # GET /members.json
  def index
    @members = Member.all

    respond_to do |format|
      format.html # index.html.erb
      format.json { render json: @members }
    end
  end

  # GET /members/1
  # GET /members/1.json
  def show
    @member = Member.find(params[:id])

    respond_to do |format|
      format.html # show.html.erb
      format.json { render json: @member }
    end
  end

  # GET /members/new
  # GET /members/new.json
  def new
    @member = Member.new

    respond_to do |format|
      format.html # new.html.erb
      format.json { render json: @member }
    end
  end

  # GET /members/1/edit
  def edit
    @member = Member.find(params[:id])
  end

  # POST /members
  # POST /members.json
  def create
    @member = Member.new(params[:member])

    respond_to do |format|
      if @member.save
        format.html { redirect_to @member, notice: 'Member was successfully created.' }
        format.json { render json: @member, status: :created, location: @member }
      else
        format.html { render action: "new" }
        format.json { render json: @member.errors, status: :unprocessable_entity }
      end
    end
  end

  # POST /members/1
  def exchange10
    member = Member.find(params[:id])

    offer_points(member, 10)
  end

  def exchange20
    member = Member.find(params[:id])

    offer_points(member, 20)
  end

  def exchange30
    member = Member.find(params[:id])

    offer_points(member, 30)
  end

  # PUT /members/1
  # PUT /members/1.json
  def update
    @member = Member.find(params[:id])

    respond_to do |format|
      if @member.update_attributes(params[:member])
        format.html { redirect_to @member, notice: 'Member was successfully updated.' }
        format.json { head :no_content }
      else
        format.html { render action: "edit" }
        format.json { render json: @member.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /members/1
  # DELETE /members/1.json
  def destroy
    @member = Member.find(params[:id])
    @member.destroy

    respond_to do |format|
      format.html { redirect_to members_url }
      format.json { head :no_content }
    end
  end

  protected
    def offer_points(member, points)

      if member.credit > points
        new_credit = member.credit - points
        if member.update_attributes(:credit => new_credit)
          record = Exchange.new
          record.member_id = member.id
          record.points = points
          if record.save
            render :text => "Offer points #{points}, create record exchange!"
          else
            render :text => "Offer points #{points}, create record exchange failed!"
          end          
        else
          render :text => "Update attribute failed!"  
        end
      else
        render :text => "No enough money!"  
      end    
    end
end
